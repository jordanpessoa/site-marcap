<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Marcap - Painel</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: 'Inter', Arial, sans-serif; display: flex; margin:0; background:#f4f6f8; color:#2f3640; height:100vh; }
    .container { display:flex; width:100%; }
    nav.sidebar { width:220px; background:#2f3640; color:#fff; display:flex; flex-direction:column; align-items:stretch; }
    nav.sidebar ul { list-style:none; padding:0; margin:0; }
    nav.sidebar li { padding:15px 20px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); transition:0.3s; }
    nav.sidebar li:hover, nav.sidebar li.active { background:#40739e; }
    main.content { flex:1; padding:20px; overflow-y:auto; background:#fff; }
    h2 { margin-top:0; color:#273c75; }
    .section-hidden { display:none; }
    .section-hidden.active { display:block; }
    .header-marcap { text-align:center; padding-bottom:10px; margin-bottom:20px; border-bottom:2px solid #dcdde1; }
    .header-marcap h1 { margin:0; font-size:28px; color:#273c75; }
    .header-marcap p { margin:5px 0 0; font-style:italic; color:#718093; }
    .switch { position:relative; display:inline-block; width:60px; height:34px; margin-top:10px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px; }
    .slider:before { position:absolute; content:""; height:26px; width:26px; left:4px; bottom:4px; background:white; transition:.4s; border-radius:50%; }
    input:checked + .slider { background-color:#44bd32; }
    input:checked + .slider:before { transform:translateX(26px); }
    .status-indicador { display:inline-flex; align-items:center; margin-left:10px; font-weight:bold; color:#718093; }
    .status-bolinha { width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .status-on { background-color:#4cd137; }
    .status-off { background-color:#e84118; }
    /* AGENDA */
    .agenda-container { display:flex; flex-direction:column; border:1px solid #c2c9d1; border-radius:5px; background:white; margin-top:10px; }
    .topbar { display:flex; align-items:center; padding:10px; background:#2d5cb6; color:white; gap:10px; flex-wrap:wrap; }
    .btn { background:#3b6fc2; border:none; color:white; padding:6px 12px; border-radius:3px; cursor:pointer; font-weight:600; }
    .btn.today { background:#1c3e75; }
    .date-text { margin-left:auto; font-weight:600; font-size:15px; }
    .toolbar { display:flex; align-items:center; background:#f4f7fc; padding:10px 15px; border-bottom:1px solid #d1d7df; gap:15px; flex-wrap:wrap; }
    .view-buttons { margin-left:auto; display:flex; gap:8px; }
    .view-buttons button { padding:6px 10px; border-radius:3px; border:1px solid #a6afbf; background:white; font-weight:600; cursor:pointer; }
    .view-buttons button.active, .view-buttons button:hover { background:#2d5cb6; border-color:#254f95; color:white; }
    .schedule { display:flex; border-top:1px solid #c2c9d1; height:400px; overflow:hidden; font-size:14px; }
    .time-column { width:70px; background:#f4f7fc; border-right:1px solid #c2c9d1; overflow-y:auto; user-select:none; }
    .time-cell { height:40px; line-height:40px; border-bottom:1px solid #d1d7df; padding-right:8px; text-align:right; color:#666; }
    .columns { flex-grow:1; display:flex; overflow-x:auto; gap:2px; }
    .column { min-width:140px; border-right:1px solid #c2c9d1; background:white; overflow-y:auto; }
    .column-header { height:40px; line-height:40px; text-align:center; font-weight:700; border-bottom:1px solid #c2c9d1; background:#d9e3fa; color:#1b3b7a; display:flex; justify-content:center; align-items:center; gap:5px; position:sticky; top:0; z-index:10; }
    .column-header input { font-weight:700; font-size:14px; border:none; background:transparent; width:80px; text-align:center; outline:none; color:#1b3b7a; }
    .column-header button { background:transparent; border:none; color:#bb3b3b; font-weight:700; cursor:pointer; font-size:16px; }
    .slot { height:40px; border-bottom:1px solid #e2e6ed; cursor:pointer; display:flex; justify-content:center; align-items:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .slot:hover { background:#e6f0ff; }
    .slot.blocked { background:#ff6767 !important; }
    .slot.scheduled { background:#74d774 !important; }
    .slot.selected { background:#cfcfcf !important; }
    .footer { padding:10px 15px; border-top:1px solid #c2c9d1; text-align:right; background:#f4f7fc; display:flex; justify-content:flex-end; gap:10px; }
  </style>
</head>
<body>
<div class="container">
  <nav class="sidebar">
    <ul>
      <li class="active">QR Code</li>
      <li>Secretária</li>
      <li>Agenda</li>
      <li>Comportamento</li>
    </ul>
  </nav>

  <main class="content">
    <div class="header-marcap">
      <h1>Marcap</h1>
      <p>"Eu sou o caminho, a verdade e a vida." — João 14:6</p>
    </div>

    <!-- QR CODE -->
    <section id="sec-qrcode" class="section-hidden active">
      <h2>Conectar ao WhatsApp</h2>
      <p>Escaneie o QR Code abaixo para conectar o bot ao seu WhatsApp (somente na primeira vez).</p>
      <button id="qrcode-btn">Gerar QR Code</button>
      <div id="qrcode-container" style="margin-top:20px; display:none;"></div>
    </section>

    <!-- SECRETÁRIA -->
    <section id="sec-secretaria" class="section-hidden">
      <h2>Controle da Secretária</h2>
      <p>Ative ou pause o atendimento automático e escolha o comportamento:</p>
      <label class="switch">
        <input type="checkbox" id="toggleSecretaria">
        <span class="slider"></span>
      </label>
      <span class="status-indicador" id="status-secretaria">
        <span class="status-bolinha status-off"></span> Desativada
      </span>
      <div style="margin-top:15px;">
        <label for="comportamento-select">Comportamento:</label>
        <select id="comportamento-select">
          <option value="formal">Formal</option>
          <option value="informal">Informal</option>
          <option value="profissional">Profissional</option>
          <option value="amigavel">Amigável</option>
        </select>
        <button class="btn" id="saveComportamento">Salvar Comportamento</button>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="sec-agenda" class="section-hidden">
      <h2>Agenda Interativa</h2>
      <div class="agenda-container">
        <div class="topbar">
          <button class="btn" id="prevDay">&lt;</button>
          <button class="btn" id="nextDay">&gt;</button>
          <button class="btn today" id="todayBtn">Hoje</button>
          <div class="date-text" id="currentDate"></div>
        </div>
        <div class="toolbar">
          <label>Profissionais:</label>
          <div class="view-buttons">
            <button id="viewDay" class="active">Dia</button>
            <button id="viewWeek">Semana</button>
          </div>
          <button class="btn" id="addColaborador">+ Adicionar Colaborador</button>
        </div>
        <div class="schedule">
          <div class="time-column" id="timeColumn"></div>
          <div class="columns" id="columnsContainer"></div>
        </div>
        <div class="footer">
          <button class="btn" id="confirmBtn">Confirmar Bloqueio</button>
          <button class="btn" id="scheduleBtn">Agendar Horários</button>
          <button class="btn" id="unlockBtn">Desbloquear Horários</button>
        </div>
      </div>
    </section>

    <!-- COMPORTAMENTO -->
    <section id="sec-comportamento" class="section-hidden">
      <h2>Configuração de Comportamento</h2>
      <form id="form-comportamento">
        <label for="comportamento-msg">Mensagem padrão:</label><br>
        <textarea id="comportamento-msg" rows="4" cols="50"></textarea><br><br>
        <button type="submit">Salvar</button>
      </form>
    </section>
  </main>
</div>

<script>
const clientId = localStorage.getItem('clientId');
const sessionId = localStorage.getItem('sessionId');
if (!clientId || !sessionId) {
  alert("Sessão expirada. Faça login novamente.");
  location.href = '/login.html';
}
const headers = {'x-session-id': sessionId, 'Content-Type': 'application/json'};

// Variáveis de controle da agenda
let currentDate = new Date();

$(document).ready(function() {

  // MENU LATERAL
  $('nav.sidebar li').click(function() {
    $('nav.sidebar li').removeClass('active');
    $(this).addClass('active');
    const idx = $(this).index();
    $('main.content section').removeClass('active');
    $('main.content section').eq(idx).addClass('active');
  });

  // Atualiza a data atual na agenda
  function updateDateDisplay() {
    $('#currentDate').text(currentDate.toLocaleDateString());
  }

  // Navegação no calendário
  $('#prevDay').click(function() {
    currentDate.setDate(currentDate.getDate() - 1);
    updateDateDisplay();
    loadAgendaData();
  });

  $('#nextDay').click(function() {
    currentDate.setDate(currentDate.getDate() + 1);
    updateDateDisplay();
    loadAgendaData();
  });

  $('#todayBtn').click(function() {
    currentDate = new Date();
    updateDateDisplay();
    loadAgendaData();
  });

  // Carrega os dados da agenda
  async function loadAgendaData() {
    try {
      const response = await fetch(`/api/agenda/${clientId}?date=${currentDate.toISOString()}`, { headers });
      const data = await response.json();
      renderAgenda(data);
    } catch (error) {
      console.error("Erro ao carregar dados da agenda", error);
    }
  }

  // Renderiza a agenda
  function renderAgenda(data) {
    // Limpa as colunas e o tempo
    $('#columnsContainer').empty();
    $('#timeColumn').empty();

    // Exibe horários na coluna esquerda
    const hours = [...Array(24).keys()];
    hours.forEach(hour => {
      const hourLabel = $('<div>').addClass('time-cell').text(`${hour}:00`);
      $('#timeColumn').append(hourLabel);
    });

    // Exibe os colaboradores
    data.professionals.forEach(prof => {
      const column = $('<div>').addClass('column');
      const columnHeader = $('<div>').addClass('column-header').text(prof.name);
      column.append(columnHeader);

      prof.schedule.forEach(slot => {
        const slotDiv = $('<div>').addClass('slot').text(slot.time);
        column.append(slotDiv);
      });

      $('#columnsContainer').append(column);
    });
  }

  // Chama a primeira carga de dados
  updateDateDisplay();
  loadAgendaData();

});
</script>

</body>
</html>





