<html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Marcap - Painel</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
body { font-family: 'Inter', Arial, sans-serif; display: flex; margin:0; background:#f4f6f8; color:#2f3640; height:100vh; }
.container { display:flex; width:100%; }
nav.sidebar { width:220px; background:#2f3640; color:#fff; display:flex; flex-direction:column; align-items:stretch; }
nav.sidebar ul { list-style:none; padding:0; margin:0; }
nav.sidebar li { padding:15px 20px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); transition:0.3s; }
nav.sidebar li:hover, nav.sidebar li.active { background:#40739e; }
main.content { flex:1; padding:20px; overflow-y:auto; background:#fff; }
h2 { margin-top:0; color:#273c75; }
.section-hidden { display:none; }
.section-hidden.active { display:block; }
.header-marcap { text-align:center; padding-bottom:10px; margin-bottom:20px; border-bottom:2px solid #dcdde1; }
.header-marcap h1 { margin:0; font-size:28px; color:#273c75; }
.header-marcap p { margin:5px 0 0; font-style:italic; color:#718093; }
.switch { position:relative; display:inline-block; width:60px; height:34px; margin-top:10px; }
.switch input { opacity:0; width:0; height:0; }
.slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px; }
.slider:before { position:absolute; content:""; height:26px; width:26px; left:4px; bottom:4px; background:white; transition:.4s; border-radius:50%; }
input:checked + .slider { background-color:#44bd32; }
input:checked + .slider:before { transform:translateX(26px); }
.status-indicador { display:inline-flex; align-items:center; margin-left:10px; font-weight:bold; color:#718093; }
.status-bolinha { width:10px; height:10px; border-radius:50%; margin-right:6px; }
.status-on { background-color:#4cd137; }
.status-off { background-color:#e84118; }
/* AGENDA */
.agenda-container { display:flex; flex-direction:column; border:1px solid #c2c9d1; border-radius:5px; background:white; margin-top:10px; }
.topbar { display:flex; align-items:center; padding:10px; background:#2d5cb6; color:white; gap:10px; flex-wrap:wrap; }
.btn { background:#3b6fc2; border:none; color:white; padding:6px 12px; border-radius:3px; cursor:pointer; font-weight:600; }
.btn.today { background:#1c3e75; }
.date-text { margin-left:auto; font-weight:600; font-size:15px; }
.toolbar { display:flex; align-items:center; background:#f4f7fc; padding:10px 15px; border-bottom:1px solid #d1d7df; gap:15px; flex-wrap:wrap; }
.view-buttons { margin-left:auto; display:flex; gap:8px; }
.view-buttons button { padding:6px 10px; border-radius:3px; border:1px solid #a6afbf; background:white; font-weight:600; cursor:pointer; }
.view-buttons button.active, .view-buttons button:hover { background:#2d5cb6; border-color:#254f95; color:white; }
.schedule { display:flex; border-top:1px solid #c2c9d1; height:400px; overflow:hidden; font-size:14px; }
.time-column { width:70px; background:#f4f7fc; border-right:1px solid #c2c9d1; overflow-y:auto; user-select:none; }
.time-cell { height:40px; line-height:40px; border-bottom:1px solid #d1d7df; padding-right:8px; text-align:right; color:#666; }
.columns { flex-grow:1; display:flex; overflow-x:auto; gap:2px; }
.column { min-width:140px; border-right:1px solid #c2c9d1; background:white; overflow-y:auto; }
.column-header { height:40px; line-height:40px; text-align:center; font-weight:700; border-bottom:1px solid #c2c9d1; background:#d9e3fa; color:#1b3b7a; display:flex; justify-content:center; align-items:center; gap:5px; position:sticky; top:0; z-index:10; }
.column-header input { font-weight:700; font-size:14px; border:none; background:transparent; width:80px; text-align:center; outline:none; color:#1b3b7a; }
.column-header button { background:transparent; border:none; color:#bb3b3b; font-weight:700; cursor:pointer; font-size:16px; }
.slot { height:40px; border-bottom:1px solid #e2e6ed; cursor:pointer; display:flex; justify-content:center; align-items:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.slot:hover { background:#e6f0ff; }
.slot.blocked { background:#ff6767 !important; }
.slot.scheduled { background:#74d774 !important; }
.slot.selected { background:#cfcfcf !important; }
.footer { padding:10px 15px; border-top:1px solid #c2c9d1; text-align:right; background:#f4f7fc; display:flex; justify-content:flex-end; gap:10px; }
</style>
</head>
<body>
<div class="container">
  <nav class="sidebar">
    <ul>
      <li class="active">QR Code</li>
      <li>Secretária</li>
      <li>Agenda</li>
      <li>Comportamento</li>
    </ul>
  </nav>

  <main class="content">
    <div class="header-marcap">
      <h1>Marcap</h1>
      <p>"Eu sou o caminho, a verdade e a vida." — João 14:6</p>
    </div>

    <!-- QR CODE -->
    <section id="sec-qrcode" class="section-hidden active">
      <h2>Conectar ao WhatsApp</h2>
      <p>Escaneie o QR Code abaixo para conectar o bot ao seu WhatsApp (somente na primeira vez).</p>
      <button id="qrcode-btn">Gerar QR Code</button>
      <div id="qrcode-container" style="margin-top:20px; display:none;"></div>
    </section>

    <!-- SECRETÁRIA -->
    <section id="sec-secretaria" class="section-hidden">
      <h2>Controle da Secretária</h2>
      <p>Ative ou pause o atendimento automático e escolha o comportamento:</p>
      <label class="switch">
        <input type="checkbox" id="toggleSecretaria">
        <span class="slider"></span>
      </label>
      <span class="status-indicador" id="status-secretaria">
        <span class="status-bolinha status-off"></span> Desativada
      </span>
      <div style="margin-top:15px;">
        <label for="comportamento-select">Comportamento:</label>
        <select id="comportamento-select">
          <option value="formal">Formal</option>
          <option value="informal">Informal</option>
          <option value="profissional">Profissional</option>
          <option value="amigavel">Amigável</option>
        </select>
        <button class="btn" id="saveComportamento">Salvar Comportamento</button>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="sec-agenda" class="section-hidden">
      <h2>Agenda Interativa</h2>
      <div class="agenda-container">
        <div class="topbar">
          <button class="btn" id="prevDay">&lt;</button>
          <button class="btn" id="nextDay">&gt;</button>
          <button class="btn today" id="todayBtn">Hoje</button>
          <div class="date-text" id="currentDate"></div>
        </div>
        <div class="toolbar">
          <label>Profissionais:</label>
          <div class="view-buttons">
            <button id="viewDay" class="active">Dia</button>
            <button id="viewWeek">Semana</button>
          </div>
          <button class="btn" id="addColaborador">+ Adicionar Colaborador</button>
        </div>
        <div class="schedule">
          <div class="time-column" id="timeColumn"></div>
          <div class="columns" id="columnsContainer"></div>
        </div>
        <div class="footer">
          <button class="btn" id="confirmBtn">Confirmar Bloqueio</button>
          <button class="btn" id="scheduleBtn">Agendar Horários</button>
          <button class="btn" id="unlockBtn">Desbloquear Horários</button>
        </div>
      </div>
    </section>

    <!-- COMPORTAMENTO -->
    <section id="sec-comportamento" class="section-hidden">
      <h2>Configuração de Comportamento</h2>
      <form id="form-comportamento">
        <label for="comportamento-msg">Mensagem padrão:</label><br>
        <textarea id="comportamento-msg" rows="4" cols="50"></textarea><br><br>
        <button type="submit">Salvar</button>
      </form>
    </section>
  </main>
</div>

<script>
const clientId = "seuClientId"; // Substitua pelo seu clientId real
const sessionId = localStorage.getItem('sessionId');
const headers = {'x-session-id': sessionId,'Content-Type':'application/json'};

$(document).ready(function(){

  // MENU LATERAL
  $('nav.sidebar li').click(function(){
    $('nav.sidebar li').removeClass('active'); $(this).addClass('active');
    const idx=$(this).index();
    $('main.content section').removeClass('active');
    $('main.content section').eq(idx).addClass('active');
  });

  // QR CODE
  $('#qrcode-btn').click(async function(){
    $('#qrcode-container').hide().html('');
    try{
      await fetch(`/api/bot/${clientId}/create`,{method:'POST',headers});
      let qr=null;
      for(let i=0;i<15;i++){
        const res = await fetch(`/api/bot/${clientId}/qr`,{headers});
        const data = await res.json();
        if(data.qr){ qr=data.qr; break; }
        await new Promise(r=>setTimeout(r,1000));
      }
      if(qr) $('#qrcode-container').html(`<img src="${qr}" alt="QR Code">`).fadeIn();
    }catch(e){ console.error(e); alert("Erro ao gerar QR Code"); }
  });

  // SECRETÁRIA
  $('#toggleSecretaria').change(async function(){
    const iaAtiva=this.checked;
    try{
      await fetch(`/api/bot/${clientId}/ia`,{method:'PATCH',headers,body:JSON.stringify({iaAtiva})});
      const bolinha=$('#status-secretaria .status-bolinha');
      if(iaAtiva){ bolinha.removeClass('status-off').addClass('status-on'); $('#status-secretaria').contents().last()[0].textContent=' Ativada'; }
      else{ bolinha.removeClass('status-on').addClass('status-off'); $('#status-secretaria').contents().last()[0].textContent=' Desativada'; }
    }catch(e){ console.error(e); alert("Erro ao atualizar IA"); }
  });

  $('#saveComportamento').click(async function(){
    const value = $('#comportamento-select').val();
    try{
      await fetch(`/api/bot/${clientId}/comportamento`,{method:'PATCH',headers,body:JSON.stringify({status:value})});
      alert("Comportamento salvo!");
    }catch(e){ console.error(e); alert("Erro ao salvar comportamento"); }
  });

  // AGENDA
  const state={professionals:["Jordan","Maria","Lucas"], startHour:7, endHour:22, interval:15, blocked:{}, scheduled:{}, selected:{}, dragging:false, activeColumn:null};
  let currentDate=new Date();
  function fmtTime(h,m){return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;}
  function fmtDate(d){const days=["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"]; const months=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"]; return `${days[d.getDay()]}, ${d.getDate()}/${months[d.getMonth()]}/${d.getFullYear()}`;}
  function updateDateText(){$('#currentDate').text(fmtDate(currentDate));}
  function ensure(obj,key){if(!obj[key]) obj[key]={};}
  function applyStyle(slot,prof,time){slot.removeClass("selected blocked scheduled"); if(state.selected[prof]?.[time]) slot.addClass("selected"); else if(state.scheduled[prof]?.[time]) slot.addClass("scheduled"); else if(state.blocked[prof]?.[time]) slot.addClass("blocked");}

  function renderTimeColumn(){const col=$('#timeColumn').empty(); for(let h=state.startHour;h<=state.endHour;h++){for(let m=0;m<60;m+=state.interval){if(h===state.endHour&&m>0) break; col.append(`<div class="time-cell">${fmtTime(h,m)}</div>`);}}}
  function renderColumns(){
    const container=$('#columnsContainer').empty();
    state.professionals.forEach((prof,idx)=>{
      const col=$('<div>').addClass('column');
      const header=$('<div>').addClass('column-header');
      const input=$(`<input value="${prof}">`).change(async e=>{
        state.professionals[idx]=e.target.value.trim()||"Sem nome";
        await fetch(`/api/bot/${clientId}/agenda/professional/${idx}`,{method:'PATCH',headers,body:JSON.stringify({name:state.professionals[idx]})});
        renderColumns();
      });
      const del=$('<button>×</button>').click(async ()=>{
        if(confirm(`Excluir ${prof}?`)){
          await fetch(`/api/bot/${clientId}/agenda/professional/${idx}`,{method:'DELETE',headers});
          state.professionals.splice(idx,1); renderColumns();
        }
      });
      header.append(input,del); col.append(header);
      for(let h=state.startHour;h<=state.endHour;h++){for(let m=0;m<60;m+=state.interval){if(h===state.endHour&&m>0) break;
        const time=fmtTime(h,m);
        const slot=$('<div>').addClass('slot').data({professional:prof,time:time});
        applyStyle(slot,prof,time);
        slot.mousedown(()=>{state.dragging=true; state.activeColumn=prof; ensure(state.selected,prof); state.selected[prof][time]=true; applyStyle(slot,prof,time);});
        slot.mouseenter(()=>{if(!state.dragging||state.activeColumn!==prof) return; ensure(state.selected,prof); state.selected[prof][time]=true; applyStyle(slot,prof,time);});
        col.append(slot);
      }}
      col.scroll(()=>{$('#timeColumn').scrollTop(col.scrollTop());});
      container.append(col);
    });
  }
  $(document).mouseup(()=>{state.dragging=false;});

  $('#confirmBtn').click(async ()=>{
    for(const prof in state.selected){ensure(state.blocked,prof); for(const time in state.selected[prof]){ state.blocked[prof][time]=true;
      await fetch(`/api/bot/${clientId}/agenda/block`,{method:'POST',headers,body:JSON.stringify({professional:prof,time})});
    }}
    state.selected={}; renderColumns(); alert("Bloqueio aplicado!");
  });

  $('#scheduleBtn').click(async ()=>{
    const nome=prompt("Nome do cliente:"); if(!nome) return;
    const serv=prompt("Serviço:"); if(!serv) return;
    const texto=`${nome} - ${serv}`;
    for(const prof in state.selected){ensure(state.scheduled,prof); for(const time in state.selected[prof]){ state.scheduled[prof][time]={text:texto};
      await fetch(`/api/bot/${clientId}/agenda/schedule`,{method:'POST',headers,body:JSON.stringify({professional:prof,time,text:texto})});
    }}
    state.selected={}; renderColumns();
  });

  $('#unlockBtn').click(async ()=>{
    state.blocked={}; state.scheduled={}; state.selected={};
    await fetch(`/api/bot/${clientId}/agenda/unlock`,{method:'POST',headers});
    renderColumns();
  });

  $('#prevDay').click(()=>{currentDate.setDate(currentDate.getDate()-1); updateDateText();});
  $('#nextDay').click(()=>{currentDate.setDate(currentDate.getDate()+1); updateDateText();});
  $('#todayBtn').click(()=>{currentDate=new Date(); updateDateText();});

  $('#addColaborador').click(async ()=>{
    const nome=prompt("Nome do colaborador:"); if(!nome) return;
    state.professionals.push(nome.trim());
    await fetch(`/api/bot/${clientId}/agenda/professional`,{method:'POST',headers,body:JSON.stringify({name:nome.trim()})});
    renderColumns();
  });

  updateDateText(); renderTimeColumn(); renderColumns();

  // COMPORTAMENTO MENSAGEM PADRÃO
  $('#form-comportamento').submit(async function(e){
    e.preventDefault();
    const msg = $('#comportamento-msg').val();
    try{
      await fetch(`/api/bot/${clientId}/message`,{method:'POST',headers,body:JSON.stringify({message:msg})});
      alert("Mensagem padrão salva!");
    }catch(e){ console.error(e); alert("Erro ao salvar mensagem"); }
  });

});
</script>
</body>
</html>